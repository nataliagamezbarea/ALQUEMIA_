<!-- Este es el contenedor principal del popover de la cesta de compras, o sea, la bolsita de productos -->
<div id="cesta" class="carrito {% if session.get('user') and cesta['numero_productos'] > 0 %}cesta-no-vacia{% endif %}" popover>
  
  <!-- En esta parte está el encabezado con el título de la cesta -->
  <header>
    <h1>
      {% if session.get("user") %}
        <!-- Si la persona ha iniciado sesión, muestro cuántos productos tiene -->
        Bolsa ({{ cesta['numero_productos'] if cesta['numero_productos'] > 0 else 0 }})
      {% else %}
        <!-- Si no ha iniciado sesión, simplemente muestro "Bolsa" -->
        Bolsa
      {% endif %}
    </h1>
    <!-- Este botón permite cerrar la vista de la cesta -->
    <button id="cerrar-cesta" aria-label="Cerrar cesta"><i class="fas fa-times"></i></button>
  </header>

  <section>
    {% if not session.get("user") %}
      <!-- Si la persona no está logueada, le indico que debe iniciar sesión para ver su cesta -->
      <div>
        Debes iniciar sesión para ver y gestionar tu cesta.
      </div>
    {% else %}
      {% if cesta["numero_productos"] == 0 %}
        <!-- En este caso la persona está logueada pero aún no ha agregado productos -->
        <div>
          Tu cesta está vacía.
        </div>
      {% else %}
        <!-- Aquí es donde muestro los productos que tiene en la cesta -->
        {% for producto_cesta in cesta['productos_cesta'] %}
          {% if producto_cesta.variante and producto_cesta.variante.producto %}
            {% set producto = producto_cesta.variante.producto %}
            {% set color = producto_cesta.variante.color %}
            {% set talla = producto_cesta.variante.talla %}

            <!-- Cada producto lo muestro dentro de este artículo -->
            <article>
              <!-- Muestro la imagen del producto, o una por defecto si no hay -->
              <img src="{{ producto_cesta.imagen_url if producto_cesta.imagen_url else url_for('static', filename='img/default_product.png') }}" alt="Imagen del producto">
              <div>
                <h3>{{ producto.nombre }}</h3>
                <!-- Aquí muestro los detalles como color y talla -->
                <p>{{ color.color if color else 'Sin color' }} | {{ talla.talla if talla else 'Sin talla' }}</p>
                
                <div>
                  <!-- Este formulario es para eliminar el producto de la cesta -->
                  <form method="post" action="{{ url_for('eliminar_producto_cesta', id_variantes=producto_cesta.variante.id_variantes) }}">
                    <button type="submit" aria-label="Eliminar producto"><i class="fas fa-trash-alt"></i></button>
                  </form>

                  <!-- Este formulario permite modificar la cantidad -->
                  <form method="post" action="{{ url_for('actualizar_cantidad_producto', id_variantes=producto_cesta.variante.id_variantes) }}">
                    <div>
                      <input type="number" name="cantidad" min="1" value="{{ producto_cesta.cantidad }}" aria-label="Cantidad de producto" onchange="this.form.submit()">
                    </div>
                  </form>

                  <!-- Muestro el precio total por ese producto según su cantidad -->
                  <p>{{ producto.precio * producto_cesta.cantidad }} €</p>
                </div>
              </div>
            </article>
          {% else %}
            <!-- En caso de que el producto ya no exista o haya sido eliminado -->
            <div>Producto no disponible.</div>
          {% endif %}
        {% endfor %}

        <!-- Si el total supera los 70€, muestro que tiene envío gratis -->
        <div {% if cesta['total'] > 70 %} style="display: block;" {% else %} style="display: none;" {% endif %}>
          <i class="fa-solid fa-truck"></i>
          <p>Tu pedido tiene <span>envío gratis</span>.</p>
        </div>

        <!-- Esta sección muestra el total general de la cesta y el botón para continuar -->
        <div>
          <div>
            <span>Total</span>
            <span>{{ cesta['total'] if cesta['total'] else '0,00 €' }} €</span>
          </div>

          <!-- Solo muestro el botón de pedido si hay productos -->
          {% if cesta['numero_productos'] > 0 %}
            <button aria-label="Ver bolsa">Realizar pedido</button>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}
  </section>
</div>
