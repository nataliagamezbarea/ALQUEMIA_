<!-- Este es el contenedor principal del popover de la cesta de compras, o sea, la bolsita de productos -->
<div id="cesta" class="carrito {% if session.get('user') and cesta['numero_productos'] > 0 %}cesta-no-vacia{% endif %}" popover>
  
  <!-- En esta parte est√° el encabezado con el t√≠tulo de la cesta -->
  <header>
    <h1>
      {% if session.get("user") %}
        <!-- Si la persona est√° logueada, muestro cu√°ntos productos hay -->
        Bolsa ({{ cesta['numero_productos'] if cesta['numero_productos'] > 0 else 0 }})
        {% else %}
        <!-- Si no ha iniciado sesi√≥n, solo muestro el texto "Bolsa" -->
        Bolsa
      {% endif %}
    </h1>
    <!-- Este botoncito es para cerrar la cesta -->
    <button id="cerrar-cesta" aria-label="Cerrar cesta"><i class="fas fa-times"></i></button>
  </header>

  <section>
    {% if not session.get("user") %}
      <!-- Si la persona no ha iniciado sesi√≥n, le aviso que debe hacerlo -->
      <div style="padding: 10px; color: red;">
        Debes iniciar sesi√≥n para ver y gestionar tu cesta.
      </div>
    {% else %}
      {% if cesta["numero_productos"] == 0 %}
        <!-- Aqu√≠ le digo que la cesta est√° vac√≠a si no ha agregado nada -->
        <div style="padding: 10px; color: gray;">
          Tu cesta est√° vac√≠a.
        </div>
      {% else %}
        <!-- Ok, ahora s√≠ hay productos üòé -->
        {% for producto_cesta in cesta['productos_cesta'] %}
          {% if producto_cesta.variante and producto_cesta.variante.producto %}
            {% set producto = producto_cesta.variante.producto %}
            {% set color = producto_cesta.variante.color %}
            {% set talla = producto_cesta.variante.talla %}

            <!-- Cada producto de la cesta lo muestro dentro de este "article" -->
            <article>
              <!-- Aqu√≠ est√° la imagen del producto, o una por defecto si no tiene -->
              <img src="{{ producto_cesta.imagen_url if producto_cesta.imagen_url else url_for('static', filename='img/default_product.png') }}" alt="Imagen del producto">
              <div>
                <h3>{{ producto.nombre }}</h3>
                <!-- Aqu√≠ muestro el color y la talla que eligi√≥ -->
                <p>{{ color.color if color else 'Sin color' }} | {{ talla.talla if talla else 'Sin talla' }}</p>
                
                <div class="producto-acciones">
                  <!-- Este formulario es para eliminar el producto -->
                  <form method="post" action="{{ url_for('eliminar_producto_cesta', id_variantes=producto_cesta.variante.id_variantes) }}">
                    <button type="submit" aria-label="Eliminar producto"><i class="fas fa-trash-alt"></i></button>
                  </form>

                  <!-- Este otro es para cambiar la cantidad -->
                  <form method="post" action="{{ url_for('actualizar_cantidad_producto', id_variantes=producto_cesta.variante.id_variantes) }}">
                    <div class="cantidad">
                      <input type="number" name="cantidad" min="1" value="{{ producto_cesta.cantidad }}" aria-label="Cantidad de producto" onchange="this.form.submit()">
                    </div>
                  </form>

                  <!-- Este es el precio total por ese producto seg√∫n la cantidad -->
                  <p class="precio-total">{{ producto.precio * producto_cesta.cantidad }} ‚Ç¨</p>
                </div>
              </div>
            </article>
          {% else %}
            <!-- Esto aparece si por alguna raz√≥n el producto ya no est√° disponible -->
            <div>Producto no disponible.</div>
          {% endif %}
        {% endfor %}

        <!-- Si el total pasa los 70‚Ç¨, digo que tiene env√≠o gratis üéâ -->
        <div class="envio-gratis flex align-center" {% if cesta['total'] > 70 %} style="display: block;" {% else %} style="display: none;" {% endif %}>
          <i class="fa-solid fa-truck"></i>
          <p>Tu pedido tiene <span>env√≠o gratis</span>.</p>
        </div>

        <div>
          <!-- Aqu√≠ muestro el total general de la cesta -->
          <div class="carrito-total flex space_between">
            <span>Total</span>
            <span>{{ cesta['total'] if cesta['total'] else '0,00 ‚Ç¨' }} ‚Ç¨</span>
          </div>

          <!-- Y si hay productos, dejo el bot√≥n para hacer el pedido -->
          {% if cesta['cesta["numero_productos"]'] > 0 %}
            <button class="button-green" aria-label="Ver bolsa">Realizar pedido</button>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}
  </section>
</div>
